using System;
using System.Collections.Generic;
using Microsoft.Exchange.Data.Directory;
using Microsoft.Exchange.Data.Directory.SystemConfiguration;
using Microsoft.Exchange.Diagnostics.Components.MalwareAgent;
using Microsoft.Exchange.Transport.Agent.Malware.Common;
using Microsoft.Office.Datacenter.ActiveMonitoring;

namespace Microsoft.Exchange.Transport.Agent.Malware
{
	internal class TenantMalwareFilterPolicies : TenantConfigurationCacheableItem<MalwareFilterPolicy>
	{
		public override long ItemSize
		{
			get
			{
				return this.estimatedSize + 8L;
			}
		}

		public int Count
		{
			get
			{
				return this.malwareFilterPolicies.Count;
			}
		}

		public override void ReadData(IConfigurationSession tenantConfigurationSession)
		{
			ADObjectId childId = tenantConfigurationSession.GetOrgContainerId().GetChildId("Transport Settings").GetChildId("Malware Filter");
			IEnumerable<MalwareFilterPolicy> enumerable = tenantConfigurationSession.FindPaged<MalwareFilterPolicy>(childId, QueryScope.OneLevel, null, null, 0, null);
			this.estimatedSize = 0L;
			if (enumerable != null)
			{
				this.malwareFilterPolicies = new Dictionary<string, MalwareFilterPolicy>(StringComparer.InvariantCultureIgnoreCase);
				foreach (MalwareFilterPolicy malwareFilterPolicy in enumerable)
				{
					if (malwareFilterPolicy.IsConflicted())
					{
						string text = string.Format("Malware Filter policy with name '{0}', distinguished name '{1}' is a conflicted object and is being ignored for Organization ID '{2}'.", malwareFilterPolicy.Name, malwareFilterPolicy.DistinguishedName, base.OrganizationId);
						MalwareAgentGlobal.EventLogger.LogEvent(AntimalwareEventLogConstants.Tuple_TenantConfigurationError, base.OrganizationId.ToString(), new object[]
						{
							base.OrganizationId,
							text
						});
					}
					else if (!this.malwareFilterPolicies.ContainsKey(malwareFilterPolicy.Name))
					{
						this.malwareFilterPolicies.Add(malwareFilterPolicy.Name, malwareFilterPolicy);
						this.estimatedSize += (long)(malwareFilterPolicy.Name.Length * 2) + malwareFilterPolicy.GetEstimatedSize();
						if (malwareFilterPolicy.IsDefault)
						{
							this.defaultPolicyName = malwareFilterPolicy.Name;
							this.estimatedSize += (long)(malwareFilterPolicy.Name.Length * 2);
						}
					}
					else
					{
						string text2 = string.Format("Malware Filter policy with name '{0}', distinguished name '{1}' already exists for Organization ID '{2}'.", malwareFilterPolicy.Name, malwareFilterPolicy.DistinguishedName, base.OrganizationId);
						EventNotificationItem.Publish(ExchangeComponent.AMTenantConfigError.Name, "AntimalwareAgent.TenantConfigurationError", null, text2, ResultSeverityLevel.Error, false);
						ExTraceGlobals.AgentTracer.TraceError((long)this.GetHashCode(), text2);
					}
				}
			}
		}

		public bool GetMalwareFilterPolicyByName(string policyName, out MalwareFilterPolicy policy)
		{
			policy = null;
			return policyName != null && this.malwareFilterPolicies != null && this.malwareFilterPolicies.TryGetValue(policyName, out policy);
		}

		public bool GetDefaultMalwareFilterPolicy(out MalwareFilterPolicy policy)
		{
			return this.GetMalwareFilterPolicyByName(this.defaultPolicyName, out policy);
		}

		private Dictionary<string, MalwareFilterPolicy> malwareFilterPolicies;

		private string defaultPolicyName;

		private long estimatedSize;
	}
}
