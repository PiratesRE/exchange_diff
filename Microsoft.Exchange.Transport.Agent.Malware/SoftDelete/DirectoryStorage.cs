using System;
using System.IO;

namespace Microsoft.Exchange.Transport.Agent.Malware.SoftDelete
{
	internal class DirectoryStorage : IStorage
	{
		public DirectoryStorage(string path, long maxThreshold, MalwareAgentPerfCountersWrapper perfCounterWrapper)
		{
			if (string.IsNullOrEmpty(path))
			{
				throw new ArgumentException("Path cannot be null or empty.");
			}
			if (!Directory.Exists(path))
			{
				throw new ArgumentException("Directory path does not exists.");
			}
			if (perfCounterWrapper == null)
			{
				throw new ArgumentException("PerfCounterWrapper cannot be null");
			}
			this.undelieverableFolderPath = path;
			this.maxThreshold = maxThreshold;
			this.CurrentDirectorySize = 0L;
			this.perfCounterWrapper = perfCounterWrapper;
		}

		public MalwareAgentPerfCountersWrapper PerfCounterWrapper
		{
			get
			{
				return this.perfCounterWrapper;
			}
		}

		public string UndelieverableFolderPath
		{
			get
			{
				return this.undelieverableFolderPath;
			}
		}

		public long MaxThreshold
		{
			get
			{
				return this.maxThreshold;
			}
		}

		public long CurrentDirectorySize { get; set; }

		public void AddToStorage(Stream message, string messageId)
		{
			if (string.IsNullOrEmpty(messageId))
			{
				throw new ArgumentException("Data cannot be added to the store using filename with a null/empty value.");
			}
			if (message == null)
			{
				throw new ArgumentNullException("Data cannot be added to the store using a null value for message.");
			}
			if (!this.TestForSufficientResources(message))
			{
				throw new StorageException("Storage did not have sufficient resources to store data.");
			}
			string text = messageId.Trim(new char[]
			{
				'<',
				'>'
			});
			text = DirectoryStorage.FileNameParser(text);
			string fullFileName = this.UndelieverableFolderPath + text;
			try
			{
				this.SaveStreamToFile(fullFileName, message);
			}
			catch (Exception innerException)
			{
				throw new StorageException("Data failed to save to stream", innerException);
			}
		}

		public string GetStorageDestination()
		{
			return this.UndelieverableFolderPath;
		}

		private static string FileNameParser(string fileName)
		{
			string text = fileName;
			foreach (char oldChar in DirectoryStorage.invalid)
			{
				text = text.Replace(oldChar, '_');
			}
			return text;
		}

		private bool TestForSufficientResources(Stream message)
		{
			if (message == null)
			{
				throw new ArgumentNullException("Cannot test for sufficient resources using a null value.");
			}
			if (!Directory.Exists(this.UndelieverableFolderPath))
			{
				throw new ArgumentException("Cannot test for sufficient resources if directory does not exists.");
			}
			long length = message.Length;
			long num = this.MaxThreshold - this.CurrentDirectorySize;
			return length <= num;
		}

		private void SaveStreamToFile(string fullFileName, Stream stream)
		{
			if (string.IsNullOrEmpty(fullFileName))
			{
				throw new ArgumentException("Cannot save to store using a null/empty value.");
			}
			if (stream == null)
			{
				throw new ArgumentNullException("cannot save to store using a null value.");
			}
			byte[] array = Obfuscate.Encode(stream);
			lock (DirectoryStorage.sync)
			{
				if (File.Exists(fullFileName + ".frf"))
				{
					DirectoryStorage.counter = (DirectoryStorage.counter + 1 & 511);
					fullFileName += string.Format("{0}{1:00}{2:00}{3:00}{4:00}{5:00}{6:000}", new object[]
					{
						DateTime.UtcNow.Year,
						DateTime.UtcNow.Day,
						DateTime.UtcNow.Month,
						DateTime.UtcNow.Hour,
						DateTime.UtcNow.Minute,
						DateTime.UtcNow.Second,
						DirectoryStorage.counter
					});
				}
				fullFileName += ".frf";
				using (Stream stream2 = File.Open(fullFileName, FileMode.CreateNew))
				{
					try
					{
						stream2.Write(array, 0, array.Length);
					}
					catch (Exception)
					{
						throw new StorageException("Message could not be written to disk");
					}
				}
			}
			try
			{
				this.CurrentDirectorySize += stream.Length;
			}
			catch (OverflowException)
			{
				this.CurrentDirectorySize = long.MaxValue;
			}
		}

		private static string invalid = new string(Path.GetInvalidFileNameChars()) + new string(Path.GetInvalidPathChars());

		private static int counter;

		private static object sync = new object();

		private readonly long maxThreshold;

		private readonly string undelieverableFolderPath;

		private MalwareAgentPerfCountersWrapper perfCounterWrapper;
	}
}
