using System;
using System.Collections.Generic;
using System.Configuration;
using System.Linq;
using System.Runtime.InteropServices;
using System.Threading;
using Microsoft.Exchange.Data.Transport.Email;
using Microsoft.Exchange.Diagnostics.Components.MalwareAgent;
using Microsoft.Exchange.UnifiedContent;
using Microsoft.Filtering;

namespace Microsoft.Exchange.Transport.Agent.Malware
{
	internal class MalwareFingerPrintManager : IDisposable
	{
		public MalwareFingerPrintManager()
		{
			string value = ConfigurationManager.AppSettings["EnableMalwareFingerPrinting"];
			if (!string.IsNullOrEmpty(value) && Convert.ToBoolean(value))
			{
				this.enableFingerPrinting = true;
			}
			if (this.enableFingerPrinting)
			{
				this.cache = MalwareFingerPrintCache.GetInstance();
				this.cachePerfCounterUpdater = new Timer(new TimerCallback(this.UpdateCachePerfCounters), null, TimeSpan.FromSeconds(30.0), TimeSpan.FromSeconds(30.0));
			}
			this.ResetCachePerfCounters();
		}

		public void AddFingerPrint(EmailMessage item, FilteringResults malwareResults, MalwareFingerPrintDetails olderFingerPrint)
		{
			if (!this.enableFingerPrinting)
			{
				return;
			}
			try
			{
				ContentManager contentManager = (ContentManager)ContentManagerFactory.ExtractContentManager(item);
				List<IExtractedContent> contentCollection = contentManager.ContentCollection;
				if (contentCollection != null)
				{
					IEnumerable<ScanResult> source = from scanResult in malwareResults.ScanResults
					where scanResult.Detections.Count != 0
					select scanResult;
					if (source.Count<ScanResult>() != 0)
					{
						IEnumerable<IGrouping<int, ScanResult>> enumerable = from scanResult in source
						group scanResult by scanResult.Stream.Id;
						foreach (IGrouping<int, ScanResult> grouping in enumerable)
						{
							SharedContent sharedContent = contentCollection.ElementAt(grouping.Key - 1) as SharedContent;
							if (sharedContent != null && sharedContent.LowFidelityHash != null && sharedContent.LowFidelityHash.Length != 0)
							{
								ScanResult scanResult2 = grouping.FirstOrDefault<ScanResult>();
								MalwareFingerPrintDetails malwareFingerPrintDetails = new MalwareFingerPrintDetails();
								malwareFingerPrintDetails.Name = scanResult2.Stream.Name;
								malwareFingerPrintDetails.Size = sharedContent.Rawsize;
								malwareFingerPrintDetails.Detections = (from detection in scanResult2.Detections
								select detection.Name).ToArray<string>();
								malwareFingerPrintDetails.LowFidelitySHA256Hash = new MalwareFingerPrint(sharedContent.LowFidelityHash);
								if (olderFingerPrint == null || !olderFingerPrint.IsLowFidelityMatch(malwareFingerPrintDetails))
								{
									if (sharedContent.HighFidelityHash == null || sharedContent.HighFidelityHash.Length == 0)
									{
										ExTraceGlobals.FingerPrintTracer.TraceDebug((long)this.GetHashCode(), "Failed to compute HighFidelity finger print hash");
									}
									else
									{
										malwareFingerPrintDetails.HighFidelitySHA256Hash = new MalwareFingerPrint(sharedContent.HighFidelityHash);
										this.cache.Add(malwareFingerPrintDetails.LowFidelitySHA256Hash, malwareFingerPrintDetails);
									}
								}
							}
						}
					}
				}
			}
			catch (Exception ex)
			{
				if (ex is OutOfMemoryException || ex is ThreadAbortException || ex is AccessViolationException || ex is SEHException)
				{
					throw;
				}
				ExTraceGlobals.FingerPrintTracer.TraceDebug<Exception>((long)this.GetHashCode(), "Failed to add in finger print cache: {0}", ex);
			}
		}

		public MalwareFingerPrintDetails GetFingerPrint(EmailMessage item)
		{
			if (!this.enableFingerPrinting)
			{
				return null;
			}
			ContentManager contentManager = (ContentManager)ContentManagerFactory.ExtractContentManager(item);
			List<IExtractedContent> contentCollection = contentManager.ContentCollection;
			if (contentCollection == null)
			{
				return null;
			}
			foreach (IExtractedContent extractedContent in contentCollection)
			{
				SharedContent sharedContent = extractedContent as SharedContent;
				if (sharedContent != null && sharedContent.LowFidelityHash != null && sharedContent.LowFidelityHash.Length != 0)
				{
					MalwareFingerPrintDetails malwareFingerPrintDetails = this.cache.Get(new MalwareFingerPrint(sharedContent.LowFidelityHash));
					if (malwareFingerPrintDetails != null)
					{
						if (this.ValidateMalwareFingerPrint(malwareFingerPrintDetails, sharedContent))
						{
							MalwareAgentDatacenterPerfCounters.FingerPrintingCacheHit.Increment();
							return malwareFingerPrintDetails;
						}
						MalwareAgentDatacenterPerfCounters.FingerPrintingCacheLowFidelityMiss.Increment();
					}
				}
			}
			return null;
		}

		public void Dispose()
		{
			this.Dispose(true);
			GC.SuppressFinalize(this);
		}

		protected virtual void Dispose(bool disposing)
		{
			if (disposing && !this.disposed)
			{
				if (this.cachePerfCounterUpdater != null)
				{
					this.cachePerfCounterUpdater.Dispose();
					this.cachePerfCounterUpdater = null;
				}
				this.ResetCachePerfCounters();
				this.disposed = true;
			}
		}

		private void UpdateCachePerfCounters(object state)
		{
			MalwareAgentDatacenterPerfCounters.ItemsInFingerPrintingCache.RawValue = this.cache.Count;
		}

		private void ResetCachePerfCounters()
		{
			MalwareAgentDatacenterPerfCounters.FingerPrintingCacheLowFidelityMiss.Reset();
			MalwareAgentDatacenterPerfCounters.FingerPrintingCacheHit.Reset();
			MalwareAgentDatacenterPerfCounters.ItemsInFingerPrintingCache.Reset();
		}

		private bool ValidateMalwareFingerPrint(MalwareFingerPrintDetails fingerPrint, SharedContent sharedContent)
		{
			return fingerPrint.Size == sharedContent.Rawsize && sharedContent.HighFidelityHash != null && sharedContent.HighFidelityHash.Length != 0 && new MalwareFingerPrint(sharedContent.HighFidelityHash).Equals(fingerPrint.HighFidelitySHA256Hash);
		}

		private readonly bool enableFingerPrinting;

		private MalwareFingerPrintCache cache;

		private Timer cachePerfCounterUpdater;

		private bool disposed;
	}
}
