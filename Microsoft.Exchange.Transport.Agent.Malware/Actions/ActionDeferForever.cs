using System;
using Microsoft.Exchange.Data.Directory.SystemConfiguration;

namespace Microsoft.Exchange.Transport.Agent.Malware.Actions
{
	internal class ActionDeferForever : ActionDefer
	{
		protected override bool AreAnyDeferralsLeft(StampDefer stamp, ScanContext context)
		{
			bool result = true;
			if (MalwareScanErrorAction.Allow == context.AgentGlobal.ServerSettings.ScanErrorAction && stamp.DeferredCount >= context.AgentGlobal.ServerSettings.DeferAttempts)
			{
				result = false;
			}
			return result;
		}

		protected override void UpdateStamp(StampDefer stamp)
		{
			stamp.MaxDeferredCount = -1;
		}

		protected override StampDefer CreateNewStamp(ScanContext context)
		{
			double num = (context.OverrideWaitTime.TotalMinutes == 0.0) ? ((double)context.AgentGlobal.ServerSettings.DeferWaitTime) : context.OverrideWaitTime.TotalMinutes;
			double waitTimeMinutes = Math.Min(num, Constants.MinutesPerDay);
			return new StampDefer(1, -1, num, StampDefer.GetRandomizedWaitTime(waitTimeMinutes), typeof(ActionDeferForever), context.IsCrashRecoverable, context.IsTimeoutRecoverable);
		}
	}
}
