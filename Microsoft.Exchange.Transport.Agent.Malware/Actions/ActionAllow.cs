using System;
using Microsoft.Exchange.Data.Mime;
using Microsoft.Exchange.Data.Transport.Routing;
using Microsoft.Exchange.Diagnostics.Components.MalwareAgent;

namespace Microsoft.Exchange.Transport.Agent.Malware.Actions
{
	internal class ActionAllow : Action
	{
		public override void Execute(ScanContext context, SubmittedMessageEventSource source, QueuedMessageEventArgs args)
		{
			ExTraceGlobals.ActionsTracer.TraceDebug((long)this.GetHashCode(), "Begin ActionAllow.Execute.");
			StampMalware stampMalware = StampMalware.Create(context.IsInService);
			try
			{
				args.MailItem.Message.RootPart.Headers.AppendChild(new TextHeader(stampMalware.Name, "1.0"));
			}
			catch (InvalidOperationException)
			{
				ExTraceGlobals.AgentTracer.TraceDebug((long)this.GetHashCode(), "Failed to add the malware stamp in ActionAllow.");
			}
			context.ScanActionExecuted = ScanAction.Allow;
			base.TrackMalwareAgentInfo(context, source);
		}
	}
}
