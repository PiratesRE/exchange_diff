using System;
using Microsoft.Exchange.Data.Transport.Routing;
using Microsoft.Exchange.Data.Transport.Smtp;
using Microsoft.Exchange.Diagnostics.Components.MalwareAgent;
using Microsoft.Filtering;
using Microsoft.Office.Datacenter.ActiveMonitoring;

namespace Microsoft.Exchange.Transport.Agent.Malware.Actions
{
	internal class ActionReject : Action
	{
		public ActionReject() : this(true)
		{
		}

		public ActionReject(bool isMalwareAgentIssue = true)
		{
			this.isMalwareAgentIssue = isMalwareAgentIssue;
		}

		public override void Execute(ScanContext context, SubmittedMessageEventSource source, QueuedMessageEventArgs args)
		{
			ExTraceGlobals.ActionsTracer.TraceDebug((long)this.GetHashCode(), "Begin ActionReject.Execute.");
			TransportMailItem transportMailItem = MalwareAgentGlobal.GetTransportMailItem(args.MailItem);
			ExTraceGlobals.ActionsTracer.TraceDebug<string, string>((long)this.GetHashCode(), "Anti-Malware agent rejected the message with {0}. Reason: {1}", (transportMailItem != null) ? string.Format("ExMessageId = {0}", transportMailItem.NetworkMessageId) : string.Format("MessageId = {0}", args.MailItem.Message.MessageId), context.ErrorDetails ?? string.Empty);
			context.ScanActionExecuted = ScanAction.Rejected;
			if (this.isMalwareAgentIssue)
			{
				EventNotificationItem.Publish(ExchangeComponent.AMScanError.Name, "AntimalwareAgent.NDR", null, string.Format("Anti-Malware agent rejected the message with {0}. Reason: {1}", (transportMailItem != null) ? string.Format("ExMessageId = {0}", transportMailItem.NetworkMessageId) : string.Format("MessageId = {0}", args.MailItem.Message.MessageId), context.ErrorDetails ?? string.Empty), ResultSeverityLevel.Error, false);
				context.ScanStatus |= ScanStatus.RejectedInternalError;
			}
			else
			{
				context.ScanStatus |= ScanStatus.RejectedExternalError;
			}
			base.TrackMalwareAgentInfo(context, source);
			AgentUtils.NdrMessage(args.MailItem, ActionReject.InvalidContentResponse);
		}

		private static readonly SmtpResponse InvalidContentResponse = new SmtpResponse("554", "5.6.0", new string[]
		{
			"Invalid message content identified by Antimalware Agent"
		});

		private readonly bool isMalwareAgentIssue;
	}
}
