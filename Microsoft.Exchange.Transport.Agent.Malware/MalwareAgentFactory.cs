using System;
using Microsoft.Exchange.Data.Transport;
using Microsoft.Exchange.Data.Transport.Routing;
using Microsoft.Exchange.Diagnostics.Components.MalwareAgent;
using Microsoft.Exchange.Transport.Agent.Malware.Common;

namespace Microsoft.Exchange.Transport.Agent.Malware
{
	public sealed class MalwareAgentFactory : RoutingAgentFactory
	{
		public MalwareAgentFactory()
		{
			this.global = new MalwareAgentGlobal();
			MalwareAgentGlobal.EventLogger.LogEvent(AntimalwareEventLogConstants.Tuple_AntimalwareAgentStarting, null, null);
			Components.PerfCountersLoaderComponent.AddCounterToGetExchangeDiagnostics(typeof(MalwareAgentPerfCounters), "MalwareAgentPerfCounters");
			ExTraceGlobals.InitializationTracer.TraceDebug((long)this.GetHashCode(), "Malware agent globals created successfully.");
		}

		public override RoutingAgent CreateAgent(SmtpServer server)
		{
			MalwareAgent result = null;
			try
			{
				if (this.global == null)
				{
					throw new ArgumentNullException("Malware agent global is null.");
				}
				result = new MalwareAgent(this.global, server);
				ExTraceGlobals.InitializationTracer.TraceDebug((long)this.GetHashCode(), "Malware agent instance created successfully.");
			}
			catch (ArgumentNullException arg)
			{
				ExTraceGlobals.InitializationTracer.TraceError<ArgumentNullException>((long)this.GetHashCode(), "Unable to instantiate malware agent. {0}", arg);
			}
			catch (Exception ex)
			{
				ExTraceGlobals.InitializationTracer.TraceError<string>((long)this.GetHashCode(), "Unable to instantiate malware agent. {0}", ex.StackTrace);
				MalwareAgentGlobal.EventLogger.LogEvent(AntimalwareEventLogConstants.Tuple_AntimalwareAgentInitializationFailed, null, new object[]
				{
					ex.Message
				});
			}
			return result;
		}

		public override void Close()
		{
			if (this.global != null)
			{
				this.global.Dispose();
				MalwareAgentGlobal.EventLogger.LogEvent(AntimalwareEventLogConstants.Tuple_AntimalwareAgentExiting, null, null);
				this.global = null;
			}
			ExTraceGlobals.InitializationTracer.TraceDebug((long)this.GetHashCode(), "Malware agent exiting.");
		}

		private MalwareAgentGlobal global;
	}
}
