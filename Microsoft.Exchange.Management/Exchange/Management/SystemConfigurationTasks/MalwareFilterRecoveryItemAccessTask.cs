using System;
using System.IO;
using System.Management.Automation;
using Microsoft.Exchange.Configuration.Tasks;
using Microsoft.Exchange.Data.Directory;
using Microsoft.Exchange.Data.Directory.SystemConfiguration;
using Microsoft.Exchange.Management.Tasks;
using Microsoft.Win32;

namespace Microsoft.Exchange.Management.SystemConfigurationTasks
{
	public abstract class MalwareFilterRecoveryItemAccessTask : Task
	{
		protected MalwareFilterRecoveryItemAccessTask()
		{
			if (!MalwareFilterRecoveryItemAccessTask.IsHubTransportServer())
			{
				base.WriteError(new CannotRunOnNonHubTransportException(), ErrorCategory.InvalidOperation, null);
			}
			string text = null;
			string text2 = null;
			using (RegistryKey registryKey = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\ExchangeServer\\v15\\Setup"))
			{
				if (registryKey != null)
				{
					string text3 = registryKey.GetValue("MsiInstallPath") as string;
					if (text3 != null)
					{
						text = Path.Combine(text3, "TransportRoles\\data\\Filtering\\Undeliverable");
						text2 = Path.Combine(text3, "TransportRoles\\Replay");
					}
				}
			}
			if (string.IsNullOrEmpty(text))
			{
				base.WriteError(new FolderLocationUnknownException(Strings.ErrorFolderLocationUnknown("TransportRoles\\data\\Filtering\\Undeliverable")), ErrorCategory.ObjectNotFound, "TransportRoles\\data\\Filtering\\Undeliverable");
			}
			if (string.IsNullOrEmpty(text2))
			{
				base.WriteError(new FolderLocationUnknownException(Strings.ErrorFolderLocationUnknown("TransportRoles\\Replay")), ErrorCategory.ObjectNotFound, "TransportRoles\\Replay");
			}
			if (!Directory.Exists(text))
			{
				base.WriteError(new FolderNotExistException(Strings.ErrorFolderNotExist(text)), ErrorCategory.ObjectNotFound, text);
			}
			if (!Directory.Exists(text2))
			{
				base.WriteError(new FolderNotExistException(Strings.ErrorFolderNotExist(text2)), ErrorCategory.ObjectNotFound, text2);
			}
			this.undeliverableItems = new UndeliverableItems(text, text2, new Task.TaskWarningLoggingDelegate(this.WriteWarning), new Task.TaskErrorLoggingDelegate(base.WriteError));
		}

		internal UndeliverableItems UndeliverableItems
		{
			get
			{
				return this.undeliverableItems;
			}
		}

		private static bool IsHubTransportServer()
		{
			ITopologyConfigurationSession topologyConfigurationSession = DirectorySessionFactory.Default.CreateTopologyConfigurationSession(false, ConsistencyMode.PartiallyConsistent, ADSessionSettings.FromRootOrgScopeSet(), 126, "IsHubTransportServer", "f:\\15.00.1497\\sources\\dev\\Management\\src\\Management\\SystemConfigurationTasks\\MessageHygiene\\MalwareFilterRecoveryItem\\MalwareFilterRecoveryItemAccessTask.cs");
			try
			{
				Server server = topologyConfigurationSession.FindLocalServer();
				return server != null && server.IsHubTransportServer;
			}
			catch (LocalServerNotFoundException)
			{
			}
			return false;
		}

		private const string ExchangeSetupKey = "SOFTWARE\\Microsoft\\ExchangeServer\\v15\\Setup";

		private const string UndeliverableFolder = "TransportRoles\\data\\Filtering\\Undeliverable";

		private const string ReplayFolder = "TransportRoles\\Replay";

		private UndeliverableItems undeliverableItems;
	}
}
