using System;
using System.Collections.Generic;
using Microsoft.Exchange.Configuration.Tasks;
using Microsoft.Exchange.Data;
using Microsoft.Exchange.Data.Common;
using Microsoft.Exchange.Data.Directory.SystemConfiguration;
using Microsoft.Exchange.Management.Tasks;
using Microsoft.Exchange.MessagingPolicies.Rules;
using Microsoft.Exchange.MessagingPolicies.Rules.Tasks;

namespace Microsoft.Exchange.Management.SystemConfigurationTasks
{
	public class MalwareFilterRule : HygieneFilterRule
	{
		public MalwareFilterRule()
		{
		}

		internal MalwareFilterRule(TransportRule transportRule, string name, int priority, RuleState state, string comments, TransportRulePredicate[] conditions, TransportRulePredicate[] exceptions, MalwareFilterPolicyIdParameter policyId) : base(transportRule, name, priority, state, comments, conditions, exceptions, policyId)
		{
			if (base.Conditions != null)
			{
				foreach (TransportRulePredicate predicate in base.Conditions)
				{
					base.SetParametersFromPredicate(predicate, false);
				}
			}
			if (base.Exceptions != null)
			{
				foreach (TransportRulePredicate predicate2 in base.Exceptions)
				{
					base.SetParametersFromPredicate(predicate2, true);
				}
			}
		}

		internal ObjectSchema Schema
		{
			get
			{
				return MalwareFilterRule.schema;
			}
		}

		public MalwareFilterPolicyIdParameter MalwareFilterPolicy
		{
			get
			{
				return base.PolicyId as MalwareFilterPolicyIdParameter;
			}
			set
			{
				base.PolicyId = value;
			}
		}

		internal override IEnumerable<Microsoft.Exchange.MessagingPolicies.Rules.Action> CreateActions()
		{
			List<Microsoft.Exchange.MessagingPolicies.Rules.Action> list = new List<Microsoft.Exchange.MessagingPolicies.Rules.Action>();
			ShortList<Argument> arguments = new ShortList<Argument>
			{
				new Value("X-MS-Exchange-Organization-MalwareFilterPolicy"),
				new Value(base.PolicyId.ToString())
			};
			list.Add(TransportRuleParser.Instance.CreateAction("SetHeader", arguments, null));
			list.Add(TransportRuleParser.Instance.CreateAction("Halt", new ShortList<Argument>(), null));
			return list;
		}

		internal override string BuildActionDescription()
		{
			return Strings.MalwareFilterActionDescription((base.PolicyId == null) ? string.Empty : base.PolicyId.ToString());
		}

		internal override void SuppressPiiData(PiiMap piiMap)
		{
			base.SuppressPiiData(piiMap);
			if (base.PolicyId != null)
			{
				base.PolicyId = SuppressingPiiProperty.TryRedactValue<ADIdParameter>(MalwareFilterRuleSchema.MalwareFilterPolicy, base.PolicyId);
			}
		}

		internal static MalwareFilterRule CreateFromInternalRule(TransportRule rule, int priority, TransportRule transportRule)
		{
			IConfigDataProvider session = null;
			if (transportRule != null)
			{
				session = transportRule.Session;
			}
			TransportRulePredicate[] conditions;
			TransportRulePredicate[] exceptions;
			TransportRuleAction[] array;
			Microsoft.Exchange.MessagingPolicies.Rules.Tasks.Rule.TryConvert(HygieneFilterRule.SupportedPredicates, HygieneFilterRule.SupportedActions, rule, out conditions, out exceptions, out array, session);
			if (array == null || array.Length != 2 || !(array[0] is SetHeaderAction) || !(array[1] is StopRuleProcessingAction))
			{
				throw new CorruptFilterRuleException(Strings.CorruptRule(rule.Name, Strings.ErrorCorruptRuleAction));
			}
			string identity = ((SetHeaderAction)array[0]).HeaderValue.ToString();
			return new MalwareFilterRule(transportRule, rule.Name, priority, rule.Enabled, rule.Comments, conditions, exceptions, new MalwareFilterPolicyIdParameter(identity));
		}

		internal static MalwareFilterRule CreateCorruptRule(int priority, TransportRule transportRule, LocalizedString errorText)
		{
			return new MalwareFilterRule(transportRule, transportRule.Name, priority, RuleState.Disabled, null, null, null, null)
			{
				isValid = false,
				errorText = errorText
			};
		}

		private static readonly MalwareFilterRuleSchema schema = ObjectSchema.GetInstance<MalwareFilterRuleSchema>();
	}
}
